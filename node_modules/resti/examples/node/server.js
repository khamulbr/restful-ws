var express = require('express');
var ejs = require('ejs');

var logger = require('morgan');
var mongoose = require('mongoose');

var routes = require('./app/routes');

mongoose.connect('mongodb://localhost/todos', function(err) {
	if (err) {
		console.log('Connection error:', err);
	} else {
		console.log('Connected to Mongodb database');
	}
});

var cookierParse = require('cookie-parser');
var bodyParser = require('body-parser');
var methodOverride = require('method-override');

var app = express();
var port = process.env.PORT || 8080;

app.use(express.static(__dirname + '/public'));
app.use(logger('dev'));
app.use(bodyParser.urlencoded({'extended': 'true'}));
app.use(bodyParser.json());
app.use(bodyParser.json({ type: 'application/vnd.api+json' }));
app.use(methodOverride());

app.engine('html', ejs.renderFile);
app.set('view engine', 'html');

app.use('/', routes);

app.use(function(req, res, next) {
	var err = new Error('Not Found');
	err.status = 404;
	next(err);
});

// development only app so un sending full stacktrace.
// bad idea in a prod environemnt.
 app.use(function(err, req, res, next) {
 	if (req.xhr) {
 		err = new Error(err);
 		res.json({ error: err });
 	} else {
		res.status(err.status || 500);
		res.render('error', {
			message: err.message,
			error: err
		});
	}
});

app.listen(port);
console.log('App listening on port:', port);

module.exports = app;